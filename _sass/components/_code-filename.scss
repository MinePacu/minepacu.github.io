// Code block with filename display
// Works with Jekyll Rouge syntax highlighter

.code-block-with-filename {
  margin-bottom: 1.5rem;
  border-radius: 0.5rem;
  overflow: hidden;
  box-shadow: 
    0 1px 3px 0 rgba(0, 0, 0, 0.1),
    0 1px 2px 0 rgba(0, 0, 0, 0.06);
  border: 1px solid var(--code-border-color);
  
  // Dark mode box shadow
  [data-mode='dark'] & {
    box-shadow: 
      0 1px 3px 0 rgba(0, 0, 0, 0.3),
      0 1px 2px 0 rgba(0, 0, 0, 0.2);
  }

  // Remove margin from pre element inside
  pre {
    margin-bottom: 0 !important;
    border-radius: 0 !important;
    
    &.with-filename {
      border-top: none;
    }
  }
}

.code-filename {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.75rem 1rem;
  background: var(--code-header-bg);
  color: var(--code-header-text);
  border-bottom: 1px solid var(--code-border-color);
  font-family: 'Consolas', 'Monaco', 'SFMono-Regular', monospace;
  font-size: 0.875rem;
  font-weight: 500;

  .filename-text {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    
    i {
      font-size: 1rem;
      opacity: 0.8;
    }
  }

  .copy-button {
    background: transparent;
    border: 1px solid transparent;
    color: var(--code-header-text);
    cursor: pointer;
    padding: 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    opacity: 0.7;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 1.75rem;
    height: 1.75rem;

    &:hover {
      opacity: 1;
      background: var(--code-header-hover);
      border-color: var(--code-border-color);
    }

    &:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
    }

    &.success {
      color: #10b981;
      opacity: 1;
    }

    &.error {
      color: #ef4444;
      opacity: 1;
    }

    i {
      font-size: 0.75rem;
    }
  }
}

// Enhanced syntax highlighting support
.code-block-with-filename {
  // Ensure Rouge highlighting works
  .highlight {
    margin-bottom: 0;
    border-radius: 0;
  }
  
  // Support for Rouge table structure (line numbers)
  .rouge-table {
    margin-bottom: 0;
    
    td {
      padding-bottom: 0.75rem !important;
      
      &.rouge-gutter {
        background: var(--code-line-bg);
        border-right: 1px solid var(--code-border-color);
      }
      
      &.rouge-code {
        background: var(--code-bg);
      }
    }
  }
}

// Manual syntax highlighting tokens (fallback)
.token {
  &.keyword {
    color: #d73a49;
    font-weight: bold;
  }
  
  &.class-name {
    color: #6f42c1;
  }
  
  &.string {
    color: #032f62;
  }
  
  &.comment {
    color: #6a737d;
    font-style: italic;
  }
  
  &.punctuation {
    color: #24292e;
  }
}

// Theme variables
:root {
  --code-header-bg: #f6f8fa;
  --code-header-text: #24292e;
  --code-header-hover: #e1e4e8;
  --code-border-color: #d0d7de;
  --code-bg: #ffffff;
  --code-line-bg: #f6f8fa;
}

[data-mode='dark'] {
  --code-header-bg: #21262d;
  --code-header-text: #f0f6fc;
  --code-header-hover: #30363d;
  --code-border-color: #30363d;
  --code-bg: #151515; /* 테마 기본값 --highlight-bg-color와 일치 */
  --code-line-bg: #151515; /* Rouge 코드와 동일한 배경 사용 */
  
  // Dark theme syntax highlighting
  .token {
    &.keyword {
      color: #ff7b72;
    }
    
    &.class-name {
      color: #ffa657;
    }
    
    &.string {
      color: #a5d6ff;
    }
    
    &.comment {
      color: #8b949e;
    }
    
    &.punctuation {
      color: #f0f6fc;
    }
  }
}

/* 기존 테마 헤더와의 통합 스타일 */
.filename-display {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-family: 'Consolas', 'Monaco', 'SFMono-Regular', monospace;
  font-size: 0.875rem;
  font-weight: 500;
  margin-right: 1rem;
  
  i {
    font-size: 1rem;
    opacity: 0.8;
  }
}

/* 기존 code-header에 filename이 추가된 경우의 스타일 */
.code-header {
  .filename-display {
    color: var(--code-header-text-color, #24292e);
  }
}

/* 라이트 모드와 다크 모드에서의 filename 스타일 */
[data-mode='dark'] .code-header .filename-display {
  color: var(--code-header-text, #f0f6fc) !important;
}

[data-mode='light'] .code-header .filename-display, 
.code-header .filename-display {
  color: var(--code-header-text-color, #24292e) !important;
}

/* code-block-with-filename 클래스가 있는 경우의 배경 수정 */
.code-block-with-filename {
  /* 라이트 모드에서 적절한 배경 */
  .highlight, .highlighter-rouge {
    background-color: var(--highlight-bg-color, #f6f8fa) !important;
  }
  
  .rouge-table td {
    background-color: var(--highlight-bg-color, #f6f8fa) !important;
  }
}

/* 다크 모드에서 강제 적용 */
[data-mode='dark'] .code-block-with-filename {
  .highlight, .highlighter-rouge {
    background-color: var(--highlight-bg-color, #151515) !important;
  }
  
  .rouge-table td {
    background-color: var(--highlight-bg-color, #151515) !important;
  }
}

// Responsive adjustments
@media (max-width: 768px) {
  .code-filename {
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
    
    .filename-text i {
      font-size: 0.9rem;
    }
    
    .copy-button {
      min-width: 1.5rem;
      height: 1.5rem;
      padding: 0.25rem;
    }
  }
}

// Ensure proper integration with existing theme styles
.content {
  .code-block-with-filename {
    margin-left: 0;
    margin-right: 0;
    
    @media (min-width: 576px) {
      margin-left: 0;
      margin-right: 0;
    }
  }
}

// Force proper whitespace handling for all code blocks
pre, code {
  white-space: pre !important;
  word-wrap: normal !important;
}

// Ensure Rouge table structure maintains formatting
.rouge-table {
  white-space: pre !important;
  
  td {
    white-space: pre !important;
  }
  
  .rouge-code pre {
    white-space: pre !important;
    overflow-x: auto;
  }
}

// Dark mode specific overrides for Jekyll's default code blocks
[data-mode='dark'] {
  // Override Jekyll's default code block backgrounds with maximum specificity
  .code-block-with-filename,
  .code-block-with-filename .highlight,
  .code-block-with-filename .highlighter-rouge,
  .code-block-with-filename div[class*="language-"],
  .code-block-with-filename .language-csharp,
  .code-block-with-filename .language-python,
  .code-block-with-filename .language-javascript,
  .code-block-with-filename .language-bash,
  .code-block-with-filename .language-shell,
  .code-block-with-filename .language-json,
  .code-block-with-filename .language-yaml,
  .code-block-with-filename .language-html,
  .code-block-with-filename .language-css {
    background-color: var(--code-bg) !important;
    background: var(--code-bg) !important;
  }
  
  .code-block-with-filename {
    .rouge-table {
      background-color: var(--code-bg) !important;
      
      td {
        background-color: var(--code-bg) !important;
        
        &.rouge-gutter {
          background-color: var(--code-line-bg) !important;
        }
        
        &.rouge-code {
          background-color: var(--code-bg) !important;
        }
      }
      
      pre {
        background-color: var(--code-bg) !important;
      }
    }
    
    pre {
      background-color: var(--code-bg) !important;
    }
    
    code {
      background-color: var(--code-bg) !important;
    }
    
    // Override any Jekyll theme specific classes
    .highlight,
    .highlighter-rouge {
      background-color: var(--code-bg) !important;
      
      pre {
        background-color: var(--code-bg) !important;
      }
    }
  }
}

// Also apply to regular code blocks without filename (for consistency)
[data-mode='dark'] {
  div[class*="language-"].highlighter-rouge {
    background-color: var(--code-bg) !important;
    background: var(--code-bg) !important;
    
    .highlight {
      background-color: var(--code-bg) !important;
      background: var(--code-bg) !important;
    }
    
    pre {
      background-color: var(--code-bg) !important;
      background: var(--code-bg) !important;
    }
    
    .rouge-table {
      background-color: var(--code-bg) !important;
      background: var(--code-bg) !important;
      
      td {
        background-color: var(--code-bg) !important;
        background: var(--code-bg) !important;
        
        &.rouge-gutter {
          background-color: var(--code-line-bg) !important;
          background: var(--code-line-bg) !important;
        }
      }
    }
  }
}

// Global dark mode code block fix (최후 수단)
[data-mode='dark'] {
  // 모든 코드 관련 요소의 배경을 강제로 다크 테마로 변경
  pre,
  code,
  .highlight,
  .highlighter-rouge,
  div[class*="language-"],
  .rouge-table,
  .rouge-table td {
    background-color: #161b22 !important;
    background: #161b22 !important;
    
    &.rouge-gutter {
      background-color: #0d1117 !important;
      background: #0d1117 !important;
    }
  }
  
  // 더 구체적인 선택자로 강제 적용
  .content pre,
  .content code,
  .content .highlight,
  .content .highlighter-rouge,
  .content div[class*="language-"],
  .content .rouge-table,
  .content .rouge-table td {
    background-color: #161b22 !important;
    background: #161b22 !important;
    color: #e6edf3 !important;
    
    &.rouge-gutter {
      background-color: #0d1117 !important;
      background: #0d1117 !important;
      color: #7d8590 !important;
    }
  }
  
  // 최대한 구체적인 선택자
  article.px-1 .content pre,
  article.px-1 .content code,
  article.px-1 .content .highlight,
  article.px-1 .content .highlighter-rouge,
  article.px-1 .content div[class*="language-"],
  article.px-1 .content .rouge-table,
  article.px-1 .content .rouge-table td {
    background-color: #161b22 !important;
    background: #161b22 !important;
    
    &.rouge-gutter {
      background-color: #0d1117 !important;
      background: #0d1117 !important;
    }
  }
  
  // Chirpy 테마 특정 클래스들
  .post-content pre,
  .post-content code,
  .post-content .highlight,
  .post-content .highlighter-rouge {
    background-color: #161b22 !important;
    background: #161b22 !important;
  }
  
  // 추가적인 강력한 규칙들
  * {
    pre, code, .highlight, .highlighter-rouge, 
    div[class*="language-"], .rouge-table, .rouge-table td {
      background-color: #161b22 !important;
      background: #161b22 !important;
      
      &.rouge-gutter {
        background-color: #0d1117 !important;
        background: #0d1117 !important;
      }
    }
  }
}